"use strict";function y(r){let e=/\$\$[\w\-_]+/g;return r.match(e)||[]}function w(r){let e=0;const t=0,n=1;function i(l){return!/^[a-zA-Z0-9_\-$]$/.test(l)}function a(l){return r[l]!=="$"||r[l+1]!=="$"?t:n}let o=[],s=0;for(;s<r.length;){for(;!a(s)&&s<r.length;)s++;for(o.push(r.slice(e,s)),e=s;!i(r[s])&&s<r.length;)s++;o.push(r.slice(e,s)),e=s}return o}function x(r){if(!r){console.error("moveCursorToEnd: No element provided");return}if(document.activeElement!==r&&r.focus(),typeof window.getSelection<"u"&&typeof document.createRange<"u"){const e=document.createRange();e.selectNodeContents(r),e.collapse(!1);const t=window.getSelection();t.removeAllRanges(),t.addRange(e)}else if(typeof document.body.createTextRange<"u"){const e=document.body.createTextRange();e.moveToElementText(r),e.collapse(!1),e.select()}}function g(r,e,t){let n=null;for(;r;){if(r.matches(e)){n=r;break}else if(t&&r.matches(t))break;r=r.parentElement}return n}function E(r,e,t="",n=!1){const i=new Set;if(!(r instanceof Element))throw new TypeError("The first argument must be a DOM Element.");if(typeof e!="string"||e.trim()==="")throw new TypeError("The second argument must be a non-empty string.");if(r.matches(e)&&!n)return r;i.add(r);let a=r;for(;a;){const o=a.parentElement;if(o){let s=o.firstElementChild;for(;s;){if(!i.has(s)){if(i.add(s),s!==a&&s.matches(e))return s;if(s.children.length>0){const l=[s.firstElementChild];for(;l.length>0;){const d=l.shift();if(!i.has(d)){if(i.add(d),d.matches(e))return d;let c=d.nextElementSibling;for(;c;)l.push(c),c=c.nextElementSibling;d.firstElementChild&&l.push(d.firstElementChild)}}}}s=s.nextElementSibling}}if(a=o,a&&!i.has(a)){if(i.add(a),a.matches(e))return a;if(t&&a.matches(t))break}}return null}function L(r){const e=(r.match(/\//g)||[]).length;return!(e>1||e===1&&r.charAt(r.length-1)!=="/")}function R(r){return r!=null&&typeof r=="string"?r.replace(/&nbsp;/g," ").replace(/&#13;/g,`
`).replace(/&amp;/g,"&").replace(/&#39;/g,"'").replace(/&quot;/g,'"').replace(/&lt;/g,"<").replace(/&gt;/g,">"):""}function b(r){return r!=null&&typeof r=="string"?r.replace(/&/g,"&amp;").replace(/'/g,"&#39;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\r\n/g,"&#13;").replace(/[\r\n]/g,"&#13;").replace(/\s/g,"&nbsp;"):r}function k(r){return r!=null&&typeof r=="string"?r.replace(/\u00A0/g," ").replace(/&nbsp;/g," ").replace(/\s+/g," ").trim():r}function A(r){return r.replace(/^[\u00A0\s]+|[\u00A0\s]+$/g,"").trim()}function M(r){return g(r,".app-container")}function P(r,e){if(!r||!(r instanceof HTMLElement))return console.error("getClosestParentWithPresenter: Invalid or no element provided"),null;const t=e?`[data-presenter="${e}"]`:"[data-presenter]";return E(r,t,"",!0)}function T(r){if(!r||!(r instanceof HTMLElement))return console.error("invalidateParentElement: Invalid or no element provided"),null;C(P(r))}function C(r){if(!r||!(r instanceof HTMLElement)){console.error("refreshElement: Invalid or no element provided");return}if(!r.webSkelPresenter||typeof r.webSkelPresenter.invalidate!="function"){console.error("refreshElement: Element does not have a webSkelPresenter with an invalidate method");return}r.webSkelPresenter.invalidate()}async function S(r,e,t){typeof e=="boolean"&&(t=e,e=void 0);const n=document.querySelector("body"),i=g(n,"dialog");i&&(i.close(),i.remove());const a=Object.assign(N(r,e),{component:r,cssClass:r,componentProps:e});return n.appendChild(a),await a.showModal(),a.addEventListener("keydown",D),t?new Promise(o=>{a.addEventListener("close",s=>{o(s.data)})}):a}function D(r){r.key==="Escape"&&r.preventDefault()}function N(r,e){let t=document.createElement("dialog"),n="";return e!==void 0&&Object.keys(e).forEach(a=>{n+=` data-${a}="${e[a]}"`}),h.instance.configs.components.find(a=>a.name===r).presenterClassName&&(n+=` data-presenter="${r}"`),n===""?t.innerHTML=`<${r}/>`:t.innerHTML=`<${r}${n}/>`,t.classList.add("modal",`${r}-dialog`),t}function j(r,e){const t=g(r,"dialog");if(e!==void 0){let n=new Event("close",{bubbles:!0,cancelable:!0});n.data=e,t.dispatchEvent(n)}t&&(t.close(),t.remove())}function $(r,e){document.removeEventListener("click",r.clickHandler),r.remove(),e!==void 0&&delete e.actionBox}async function H(r,e,t,n,i={}){if(r.parentNode.querySelector(t))return null;const o=document.createElement(`${t}`);for(const[d,c]of Object.entries(i))o.setAttribute(`data-${d}`,c);let s;switch(n){case"prepend":r.parentNode.insertBefore(o,r);break;case"append":r.parentNode.appendChild(o);break;case"replace":s=r;const d=s.parentNode;d.removeChild(s),d.appendChild(o);break;case"replace-all":s=r.parentNode;const c=s;s=c.innerHTML,c.innerHTML="",c.appendChild(o);break;default:console.error(`Invalid Insertion Mode: ${n}. No changes to the DOM have been made`);return}let l=d=>{if(o&&!o.contains(d.target)){if(n==="replace"&&s){const c=o.parentNode;c.removeChild(o),c.appendChild(s)}else if(n==="replace-all"&&s){const c=o.parentNode;c.innerHTML=s}$(o)}};return o.clickHandler=l,document.addEventListener("click",l),o}class v{constructor(){this.loadedStyleSheets=new Map,this.components={}}async loadStyleSheets(e,t){const n=[];return n.push(...e.map(i=>this.loadStyleSheet({cssText:i,identifier:t}))),(await Promise.all(n)).join("")}async loadStyleSheet({url:e=null,cssText:t=null,identifier:n=null}){if(!e&&!t)return;const i=n||e;let a=this.loadedStyleSheets.get(i)||0;if(a===0)return new Promise((o,s)=>{try{const l=document.createElement("style");l.textContent=t,n&&(l.className=n),document.head.appendChild(l),this.loadedStyleSheets.set(i,a+1),o(l.outerHTML)}catch(l){s(new Error(`Failed to inject the CSS text: ${l.message}`))}});this.loadedStyleSheets.set(i,a+1)}async unloadStyleSheets(e){let t=this.loadedStyleSheets.get(e);t!==void 0&&(t-=1,t<=0?(this.removeStyleSheet(e),this.loadedStyleSheets.delete(e)):this.loadedStyleSheets.set(e,t))}removeStyleSheet(e){Array.from(document.head.querySelectorAll(`link[class="${e}"], style[class="${e}"]`)).forEach(n=>document.head.removeChild(n))}async loadComponent(e){if(this.components[e.name]){if(this.components[e.name].isPromiseFulfilled)return await this.loadStyleSheets(this.components[e.name].css,e.name),{html:this.components[e.name].html,css:this.components[e.name].css};{let t=await this.components[e.name].loadingPromise;return await this.loadStyleSheets(t.css,e.name),t}}else return this.components[e.name]={html:"",css:[],presenter:null,loadingPromise:null,isPromiseFulfilled:!1},this.components[e.name].loadingPromise=(async()=>{try{let t,n;e.directory?(t=`./${h.instance.configs.webComponentsRootDir}/${e.directory}/${e.type}/${e.name}/${e.name}.html`,n=`./${h.instance.configs.webComponentsRootDir}/${e.directory}/${e.type}/${e.name}/${e.name}.css`):(t=`./${h.instance.configs.webComponentsRootDir}/${e.type}/${e.name}/${e.name}.html`,n=`./${h.instance.configs.webComponentsRootDir}/${e.type}/${e.name}/${e.name}.css`);const i=e.loadedTemplate||await(await fetch(t)).text();this.components[e.name].html=i;const a=e.loadedCSSs||[await(await fetch(n)).text()];if(this.components[e.name].css=a,await this.loadStyleSheets(a,e.name),e.presenterClassName)if(e.presenterModule)this.registerPresenter(e.name,e.presenterModule[e.presenterClassName]);else{let o;e.directory?o=`../../${h.instance.configs.webComponentsRootDir}/${e.directory}/${e.type}/${e.name}/${e.name}.js`:o=`../../${h.instance.configs.webComponentsRootDir}/${e.type}/${e.name}/${e.name}.js`;const s=await import(o);this.registerPresenter(e.name,s[e.presenterClassName])}return this.components[e.name].isPromiseFulfilled=!0,{html:i,css:a}}catch(t){throw t}})()}registerPresenter(e,t){this.components[e].presenter=t}initialisePresenter(e,t,n,i={}){let a;try{a=new this.components[t.componentName].presenter(t,n,i),t.isPresenterReady=!0,t.onPresenterReady()}catch(o){showApplicationError("Error creating a presenter instance",`Encountered an error during the initialization of ${e} for component: ${t.componentName}`,o+":"+o.stack.split(`
`)[1])}return a}}class h{constructor(){this._appContent={},this.appServices={},this._documentElement=document,this.actionRegistry={},this.registerListeners(),this.ResourceManager=new v,this.defaultLoader=document.createElement("dialog"),this.loaderCount=0,this.defaultLoader.classList.add("spinner"),this.defaultLoader.classList.add("spinner-default-style"),window.showApplicationError=async(e,t,n)=>await S("show-error-modal",{title:e,message:t,technical:n}),console.log("creating new app manager instance")}static async initialise(e){if(h.instance)return h.instance;let t=new h;const n=["./utils/dom-utils.js","./utils/form-utils.js","./utils/modal-utils.js","./utils/template-utils.js","./utils/browser-utils.js"];for(const i of n){const a=await import(i);for(const[o,s]of Object.entries(a))t[o]=s}return await t.loadConfigs(e),h.instance=t,h.instance}async loadConfigs(e){try{const n=await(await fetch(e)).json();this.configs=n;for(const i of n.services){const a=await import(i.path);this.initialiseService(a[i.name])}for(const i of n.components)await this.defineComponent(i)}catch(t){console.error(t),await showApplicationError("Error loading configs","Error loading configs",`Encountered ${t} while trying loading webSkel configs`)}}initialiseService(e){let t=new e;Object.getOwnPropertyNames(e.prototype).filter(i=>i!=="constructor").forEach(i=>{this.appServices[i]=t[i].bind(t)})}showLoading(){let e=this.defaultLoader.cloneNode(!0),t=crypto.randomUUID();return e.setAttribute("data-id",t),this.loaderCount===0?(document.body.appendChild(e),e.showModal()):this.loaderCount++,t}hideLoading(e){if(this.loaderCount>1){this.loaderCount--;return}if(e){let t=document.querySelector(`[data-id = '${e}' ]`);t&&(t.close(),t.remove())}else document.querySelectorAll(".spinner").forEach(n=>{n.close(),n.remove()})}setLoading(e){this.defaultLoader.innerHTML=e,this.defaultLoader.classList.remove("spinner-default-style")}resetLoading(){this.defaultLoader=document.createElement("dialog"),this.defaultLoader.classList.add("spinner"),this.defaultLoader.classList.add("spinner-default-style")}async changeToDynamicPage(e,t,n,i){try{this.validateTagName(e)}catch(s){showApplicationError(s,s,s),console.error(s);return}const a=this.showLoading();let o="";n&&(o=Object.entries(n).map(([s,l])=>`data-${s}="${l}"`).join(" "));try{const s=`<${e} data-presenter="${e}" ${o}></${e}>`;if(!i){const l=["#",t].join("");window.history.pushState({pageHtmlTagName:e,relativeUrlContent:s},l.toString(),l)}this.updateAppContent(s)}catch(s){console.error("Failed to change page",s)}finally{this.hideLoading(a)}}validateTagName(e){if(!/^(?![0-9])[a-z0-9]+(?:-*[a-z0-9]+)*-*?$/.test(e))throw new Error(`Invalid tag name: ${e}`);if(!this.configs.components.find(i=>i.name===e))throw new Error(`Element not found in configs: ${e}`)}async changeToStaticPage(e,t){const n=this.showLoading();try{const i=await this.fetchTextResult(e,t);this.updateAppContent(i)}catch(i){console.log("Failed to change page",i)}finally{this.hideLoading(n)}}async interceptAppContentLinks(e){let t=e.target||e.srcElement;if(t.hasAttribute("data-page")){let n=t.getAttribute("data-page");return e.preventDefault(),await this.changeToDynamicPage(n)}if(t.hasAttribute("data-path")){let n=t.getAttribute("data-path");return e.preventDefault(),await this.changeToStaticPage(n)}}setDomElementForPages(e){this._appContent=e}updateAppContent(e){try{this.preventExternalResources(e)}catch(t){showApplicationError(t,t,t),console.error(t);return}this._appContent.innerHTML=e}preventExternalResources(e){let t=/(src|href|action|onclick)\s*=\s*"[^"]*"/g,n=e.match(t);if(n)for(let i of n){let a=i.split('"')[1],o=new URL(a).host;if(window.location.host!==o)throw new Error(`External resource detected: ${a}`)}}registerListeners(){this._documentElement.addEventListener("click",this.interceptAppContentLinks.bind(this)),window.onpopstate=e=>{e.state&&e.state.relativeUrlContent&&this.updateAppContent(e.state.relativeUrlContent)},this._documentElement.addEventListener("click",async e=>{let t=e.target,n=!1;for(;t&&t!==this._documentElement&&!n;){if(t.hasAttribute("data-local-action")){e.preventDefault(),e.stopPropagation(),n=!0;let i=t,a=!1;const o=t.getAttribute("data-local-action"),[s,...l]=o.split(" ");for(;a===!1;){let d=!1,c;for(;d===!1;){if(i.webSkelPresenter){d=!0,c=i.webSkelPresenter;break}if(i=i.parentElement,i===document){await showApplicationError("Error executing action","Action not found in any Presenter","Action not found in any Presenter");return}}if(c[s]!==void 0)try{i.webSkelPresenter[s](t,...l),a=!0}catch(f){console.error(f),await showApplicationError("Error executing action","There is no action for the button to execute",`Encountered ${f}`);return}else d=!1,i=i.parentElement}}else if(t.hasAttribute("data-action")){e.preventDefault(),e.stopPropagation(),n=!0;const i=t.getAttribute("data-action"),[a,...o]=i.split(" ");a?this.callAction(a,t,...o):console.error(`${t} : data action attribute value should not be empty!`);break}t=t.parentElement}})}registerAction(e,t){this.actionRegistry[e]=t}callAction(e,...t){const n=this.actionRegistry[e];if(!n)throw new Error(`No action handler registered for "${e}"`);let i=t&&t[0]instanceof HTMLElement?t[0]:null;n.call(i,...t)}async fetchTextResult(e,t){const n=new URL(`${window.location.protocol}//${window.location.host}`);e.startsWith("#")&&(e=e.slice(1)),console.log("Fetching Data from URL: ",n+e);const i=await fetch(n+e);if(!i.ok)throw new Error("Failed to execute request");const a=await i.text();if(!t){const o=n+"#"+e;window.history.pushState({relativeUrlPath:e,relativeUrlContent:a},o.toString(),o)}return a}createElement(e,t=null,n={},i={},a=!1){const o=document.createElement(e),{proxy:s,revoke:l}=this.createReactiveProxy(n,a,o);o.setAttribute("data-presenter",e);const d={get(f,u,p){if(u==="element")return new WeakRef(o);if(u in s)return Reflect.get(s,u,p);if(u in o){const m=o[u];return typeof m=="function"?m.bind(o):m}return Reflect.get(f,u,p)},set(f,u,p,m){return u==="element"?!1:u in s?Reflect.set(s,u,p,m):u in o?(o[u]=p,!0):Reflect.set(s,u,p,m)},has(f,u){return u==="element"||u in s||u in o},ownKeys(f){const u=Reflect.ownKeys(s),p=Reflect.ownKeys(o);return[...new Set([...u,...p,"element"])]},getOwnPropertyDescriptor(f,u){return u==="element"?{value:new WeakRef(o),writable:!1,enumerable:!0,configurable:!1}:u in s?Reflect.getOwnPropertyDescriptor(s,u):u in o?Reflect.getOwnPropertyDescriptor(o,u):Reflect.getOwnPropertyDescriptor(f,u)}},c=new Proxy({},d);return o._webSkelProps={raw:n,proxy:s,revoke:l,observeProps:a},Object.entries(i).forEach(([f,u])=>{o.setAttribute(f,u)}),t instanceof HTMLElement?t?.appendChild(o):typeof t=="string"&&document.querySelector(t)?.appendChild(o),c}createReactiveProxy(e,t,n){const i={set(s,l,d){t&&typeof d=="object"&&d!==null&&(d=this.createReactiveProxy(d,t,n).proxy);const c=s[l];return s[l]=d,Object.is(c,d)||n.invalidateProxy?.(),!0},deleteProperty(s,l){return delete s[l],n.invalidateProxy?.(),!0}},{proxy:a,revoke:o}=Proxy.revocable(e,i);if(t)for(const s in e)typeof e[s]=="object"&&e[s]!==null&&(e[s]=this.createReactiveProxy(e[s],t,n).proxy);return{proxy:a,revoke:o}}defineComponent=async e=>{customElements.get(e.name)||customElements.define(e.name,class extends HTMLElement{constructor(){super(),this.variables={},this.componentName=e.name,this.props={},this.presenterReadyPromise=new Promise(t=>{this.onPresenterReady=t}),this.isPresenterReady=!1}invalidateProxy(){this.invalidateFn&&this.invalidateFn()}async connectedCallback(){this._webSkelProps&&(this.props=this._webSkelProps.proxy),this.resources=await h.instance.ResourceManager.loadComponent(e),y(this.resources.html).forEach(a=>{a=a.slice(2),this.variables[a]=""}),this.templateArray=w(this.resources.html);let n=this,i=null;for(const a of n.attributes)n.variables[a.nodeName]=b(a.nodeValue),a.name==="data-presenter"&&(i=a.nodeValue);if(i){const a=async s=>{const l=c=>{n.innerHTML=`Error rendering component: ${n.componentName}
: `+c+c.stack.split(`
`)[1],console.error(c),h.instance.hideLoading()},d=async()=>{try{await n.webSkelPresenter.beforeRender();for(let c in n.variables)typeof n.webSkelPresenter[c]<"u"&&(n.variables[c]=n.webSkelPresenter[c]);n.refresh(),await n.webSkelPresenter.afterRender?.()}catch(c){l(c)}};if(h.instance.showLoading(),s)try{await s()}catch(c){return l(c)}await d(),h.instance.hideLoading()},o=new Proxy(a,{apply:async function(s,l,d){return n.isPresenterReady||await n.presenterReadyPromise,Reflect.apply(s,l,d)}});n.invalidateFn=o,n.webSkelPresenter=h.instance.ResourceManager.initialisePresenter(i,n,o,this.props)}else n.refresh()}async disconnectedCallback(){this._webSkelProps?.revoke(),this.webSkelPresenter&&this.webSkelPresenter.afterUnload&&await this.webSkelPresenter.afterUnload(),this.resources&&this.resources.css&&await h.instance.ResourceManager.unloadStyleSheets(this.componentName)}refresh(){let t="";for(let n of this.templateArray)n.startsWith("$$")?t+=this.variables[n.slice(2)]:t+=n;this.innerHTML=t}})}}exports.ResourceManager=v;exports.WebSkel=h;exports.closeModal=j;exports.createTemplateArray=w;exports.customTrim=A;exports.findDoubleDollarWords=y;exports.getClosestParentElement=g;exports.getClosestParentWithPresenter=P;exports.getMainAppContainer=M;exports.invalidateParentElement=T;exports.moveCursorToEnd=x;exports.normalizeSpaces=k;exports.notBasePage=L;exports.refreshElement=C;exports.removeActionBox=$;exports.reverseQuerySelector=E;exports.sanitize=b;exports.showActionBox=H;exports.showModal=S;exports.unsanitize=R;
