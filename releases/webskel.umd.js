(function(m,w){typeof exports=="object"&&typeof module<"u"?module.exports=w():typeof define=="function"&&define.amd?define(w):(m=typeof globalThis<"u"?globalThis:m||self,m.WebSkel=w())})(this,function(){"use strict";function m(o){let e=/\$\$[\w\-_]+/g;return o.match(e)||[]}function w(o){let e=0;const t=0,s=1;function n(l){return!/^[a-zA-Z0-9_\-$]$/.test(l)}function i(l){return o[l]!=="$"||o[l+1]!=="$"?t:s}let a=[],r=0;for(;r<o.length;){for(;!i(r)&&r<o.length;)r++;for(a.push(o.slice(e,r)),e=r;!n(o[r])&&r<o.length;)r++;a.push(o.slice(e,r)),e=r}return a}function g(o,e,t){let s=null;for(;o;){if(o.matches(e)){s=o;break}o=o.parentElement}return s}function E(o){return o!=null&&typeof o=="string"?o.replace(/&/g,"&amp;").replace(/'/g,"&#39;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\r\n/g,"&#13;").replace(/[\r\n]/g,"&#13;").replace(/\s/g,"&nbsp;"):o}async function S(o,e,t){typeof e=="boolean"&&(t=e,e=void 0);const s=document.querySelector("body"),n=g(s,"dialog");n&&(n.close(),n.remove());const i=Object.assign($(o,e),{component:o,cssClass:o,componentProps:e});return s.appendChild(i),await i.showModal(),i.addEventListener("keydown",P),t?new Promise(a=>{i.addEventListener("close",r=>{a(r.data)})}):i}function P(o){o.key==="Escape"&&o.preventDefault()}function $(o,e){let t=document.createElement("dialog"),s="";return e!==void 0&&Object.keys(e).forEach(i=>{s+=` data-${i}="${e[i]}"`}),d.instance.configs.components.find(i=>i.name===o).presenterClassName&&(s+=` data-presenter="${o}"`),s===""?t.innerHTML=`<${o}/>`:t.innerHTML=`<${o}${s}/>`,t.classList.add("modal",`${o}-dialog`),t}class b{constructor(){this.loadedStyleSheets=new Map,this.components={}}async loadStyleSheets(e,t){const s=[];return s.push(...e.map(n=>this.loadStyleSheet({cssText:n,identifier:t}))),(await Promise.all(s)).join("")}async loadStyleSheet({url:e=null,cssText:t=null,identifier:s=null}){if(!e&&!t)return;const n=s||e;let i=this.loadedStyleSheets.get(n)||0;if(i===0)return new Promise((a,r)=>{try{const l=document.createElement("style");l.textContent=t,s&&(l.className=s),document.head.appendChild(l),this.loadedStyleSheets.set(n,i+1),a(l.outerHTML)}catch(l){r(new Error(`Failed to inject the CSS text: ${l.message}`))}});this.loadedStyleSheets.set(n,i+1)}async unloadStyleSheets(e){let t=this.loadedStyleSheets.get(e);t!==void 0&&(t-=1,t<=0?(this.removeStyleSheet(e),this.loadedStyleSheets.delete(e)):this.loadedStyleSheets.set(e,t))}removeStyleSheet(e){Array.from(document.head.querySelectorAll(`link[class="${e}"], style[class="${e}"]`)).forEach(s=>document.head.removeChild(s))}async loadComponent(e){if(this.components[e.name]){if(this.components[e.name].isPromiseFulfilled)return await this.loadStyleSheets(this.components[e.name].css,e.name),{html:this.components[e.name].html,css:this.components[e.name].css};{let t=await this.components[e.name].loadingPromise;return await this.loadStyleSheets(t.css,e.name),t}}else return this.components[e.name]={html:"",css:[],presenter:null,loadingPromise:null,isPromiseFulfilled:!1},this.components[e.name].loadingPromise=(async()=>{try{let t,s;e.directory?(t=`./${d.instance.configs.webComponentsRootDir}/${e.directory}/${e.type}/${e.name}/${e.name}.html`,s=`./${d.instance.configs.webComponentsRootDir}/${e.directory}/${e.type}/${e.name}/${e.name}.css`):(t=`./${d.instance.configs.webComponentsRootDir}/${e.type}/${e.name}/${e.name}.html`,s=`./${d.instance.configs.webComponentsRootDir}/${e.type}/${e.name}/${e.name}.css`);const n=e.loadedTemplate||await(await fetch(t)).text();this.components[e.name].html=n;const i=e.loadedCSSs||[await(await fetch(s)).text()];if(this.components[e.name].css=i,await this.loadStyleSheets(i,e.name),e.presenterClassName)if(e.presenterModule)this.registerPresenter(e.name,e.presenterModule[e.presenterClassName]);else{let a;e.directory?a=`../../${d.instance.configs.webComponentsRootDir}/${e.directory}/${e.type}/${e.name}/${e.name}.js`:a=`../../${d.instance.configs.webComponentsRootDir}/${e.type}/${e.name}/${e.name}.js`;const r=await import(a);this.registerPresenter(e.name,r[e.presenterClassName])}return this.components[e.name].isPromiseFulfilled=!0,{html:n,css:i}}catch(t){throw t}})()}registerPresenter(e,t){this.components[e].presenter=t}initialisePresenter(e,t,s,n={}){let i;try{i=new this.components[t.componentName].presenter(t,s,n),t.isPresenterReady=!0,t.onPresenterReady()}catch(a){showApplicationError("Error creating a presenter instance",`Encountered an error during the initialization of ${e} for component: ${t.componentName}`,a+":"+a.stack.split(`
`)[1])}return i}}class d{constructor(){this._appContent={},this.appServices={},this._documentElement=document,this.actionRegistry={},this.registerListeners(),this.ResourceManager=new b,this.defaultLoader=document.createElement("dialog"),this.loaderCount=0,this.defaultLoader.classList.add("spinner"),this.defaultLoader.classList.add("spinner-default-style"),window.showApplicationError=async(e,t,s)=>await S("show-error-modal",{title:e,message:t,technical:s}),console.log("creating new app manager instance")}static async initialise(e){if(d.instance)return d.instance;let t=new d;const s=["./utils/dom-utils.js","./utils/form-utils.js","./utils/modal-utils.js","./utils/template-utils.js","./utils/browser-utils.js"];for(const n of s){const i=await import(n);for(const[a,r]of Object.entries(i))t[a]=r}return await t.loadConfigs(e),d.instance=t,d.instance}async loadConfigs(e){try{const s=await(await fetch(e)).json();this.configs=s;for(const n of s.services){const i=await import(n.path);this.initialiseService(i[n.name])}for(const n of s.components)await this.defineComponent(n)}catch(t){console.error(t),await showApplicationError("Error loading configs","Error loading configs",`Encountered ${t} while trying loading webSkel configs`)}}initialiseService(e){let t=new e;Object.getOwnPropertyNames(e.prototype).filter(n=>n!=="constructor").forEach(n=>{this.appServices[n]=t[n].bind(t)})}showLoading(){let e=this.defaultLoader.cloneNode(!0),t=crypto.randomUUID();return e.setAttribute("data-id",t),this.loaderCount===0?(document.body.appendChild(e),e.showModal()):this.loaderCount++,t}hideLoading(e){if(this.loaderCount>1){this.loaderCount--;return}if(e){let t=document.querySelector(`[data-id = '${e}' ]`);t&&(t.close(),t.remove())}else document.querySelectorAll(".spinner").forEach(s=>{s.close(),s.remove()})}setLoading(e){this.defaultLoader.innerHTML=e,this.defaultLoader.classList.remove("spinner-default-style")}resetLoading(){this.defaultLoader=document.createElement("dialog"),this.defaultLoader.classList.add("spinner"),this.defaultLoader.classList.add("spinner-default-style")}async changeToDynamicPage(e,t,s,n){try{this.validateTagName(e)}catch(r){showApplicationError(r,r,r),console.error(r);return}const i=this.showLoading();let a="";s&&(a=Object.entries(s).map(([r,l])=>`data-${r}="${l}"`).join(" "));try{const r=`<${e} data-presenter="${e}" ${a}></${e}>`;if(!n){const l=["#",t].join("");window.history.pushState({pageHtmlTagName:e,relativeUrlContent:r},l.toString(),l)}this.updateAppContent(r)}catch(r){console.error("Failed to change page",r)}finally{this.hideLoading(i)}}validateTagName(e){if(!/^(?![0-9])[a-z0-9]+(?:-*[a-z0-9]+)*-*?$/.test(e))throw new Error(`Invalid tag name: ${e}`);if(!this.configs.components.find(n=>n.name===e))throw new Error(`Element not found in configs: ${e}`)}async changeToStaticPage(e,t){const s=this.showLoading();try{const n=await this.fetchTextResult(e,t);this.updateAppContent(n)}catch(n){console.log("Failed to change page",n)}finally{this.hideLoading(s)}}async interceptAppContentLinks(e){let t=e.target||e.srcElement;if(t.hasAttribute("data-page")){let s=t.getAttribute("data-page");return e.preventDefault(),await this.changeToDynamicPage(s)}if(t.hasAttribute("data-path")){let s=t.getAttribute("data-path");return e.preventDefault(),await this.changeToStaticPage(s)}}setDomElementForPages(e){this._appContent=e}updateAppContent(e){try{this.preventExternalResources(e)}catch(t){showApplicationError(t,t,t),console.error(t);return}this._appContent.innerHTML=e}preventExternalResources(e){let t=/(src|href|action|onclick)\s*=\s*"[^"]*"/g,s=e.match(t);if(s)for(let n of s){let i=n.split('"')[1],a=new URL(i).host;if(window.location.host!==a)throw new Error(`External resource detected: ${i}`)}}registerListeners(){this._documentElement.addEventListener("click",this.interceptAppContentLinks.bind(this)),window.onpopstate=e=>{e.state&&e.state.relativeUrlContent&&this.updateAppContent(e.state.relativeUrlContent)},this._documentElement.addEventListener("click",async e=>{let t=e.target,s=!1;for(;t&&t!==this._documentElement&&!s;){if(t.hasAttribute("data-local-action")){e.preventDefault(),e.stopPropagation(),s=!0;let n=t,i=!1;const a=t.getAttribute("data-local-action"),[r,...l]=a.split(" ");for(;i===!1;){let u=!1,h;for(;u===!1;){if(n.webSkelPresenter){u=!0,h=n.webSkelPresenter;break}if(n=n.parentElement,n===document){await showApplicationError("Error executing action","Action not found in any Presenter","Action not found in any Presenter");return}}if(h[r]!==void 0)try{n.webSkelPresenter[r](t,...l),i=!0}catch(f){console.error(f),await showApplicationError("Error executing action","There is no action for the button to execute",`Encountered ${f}`);return}else u=!1,n=n.parentElement}}else if(t.hasAttribute("data-action")){e.preventDefault(),e.stopPropagation(),s=!0;const n=t.getAttribute("data-action"),[i,...a]=n.split(" ");i?this.callAction(i,t,...a):console.error(`${t} : data action attribute value should not be empty!`);break}t=t.parentElement}})}registerAction(e,t){this.actionRegistry[e]=t}callAction(e,...t){const s=this.actionRegistry[e];if(!s)throw new Error(`No action handler registered for "${e}"`);let n=t&&t[0]instanceof HTMLElement?t[0]:null;s.call(n,...t)}async fetchTextResult(e,t){const s=new URL(`${window.location.protocol}//${window.location.host}`);e.startsWith("#")&&(e=e.slice(1)),console.log("Fetching Data from URL: ",s+e);const n=await fetch(s+e);if(!n.ok)throw new Error("Failed to execute request");const i=await n.text();if(!t){const a=s+"#"+e;window.history.pushState({relativeUrlPath:e,relativeUrlContent:i},a.toString(),a)}return i}createElement(e,t=null,s={},n={},i=!1){const a=document.createElement(e),{proxy:r,revoke:l}=this.createReactiveProxy(s,i,a);a.setAttribute("data-presenter",e);const u={get(f,c,y){if(c==="element")return new WeakRef(a);if(c in r)return Reflect.get(r,c,y);if(c in a){const p=a[c];return typeof p=="function"?p.bind(a):p}return Reflect.get(f,c,y)},set(f,c,y,p){return c==="element"?!1:c in r?Reflect.set(r,c,y,p):c in a?(a[c]=y,!0):Reflect.set(r,c,y,p)},has(f,c){return c==="element"||c in r||c in a},ownKeys(f){const c=Reflect.ownKeys(r),y=Reflect.ownKeys(a);return[...new Set([...c,...y,"element"])]},getOwnPropertyDescriptor(f,c){return c==="element"?{value:new WeakRef(a),writable:!1,enumerable:!0,configurable:!1}:c in r?Reflect.getOwnPropertyDescriptor(r,c):c in a?Reflect.getOwnPropertyDescriptor(a,c):Reflect.getOwnPropertyDescriptor(f,c)}},h=new Proxy({},u);return a._webSkelProps={raw:s,proxy:r,revoke:l,observeProps:i},Object.entries(n).forEach(([f,c])=>{a.setAttribute(f,c)}),t instanceof HTMLElement?t?.appendChild(a):typeof t=="string"&&document.querySelector(t)?.appendChild(a),h}createReactiveProxy(e,t,s){const n={set(r,l,u){t&&typeof u=="object"&&u!==null&&(u=this.createReactiveProxy(u,t,s).proxy);const h=r[l];return r[l]=u,Object.is(h,u)||s.invalidateProxy?.(),!0},deleteProperty(r,l){return delete r[l],s.invalidateProxy?.(),!0}},{proxy:i,revoke:a}=Proxy.revocable(e,n);if(t)for(const r in e)typeof e[r]=="object"&&e[r]!==null&&(e[r]=this.createReactiveProxy(e[r],t,s).proxy);return{proxy:i,revoke:a}}defineComponent=async e=>{customElements.get(e.name)||customElements.define(e.name,class extends HTMLElement{constructor(){super(),this.variables={},this.componentName=e.name,this.props={},this.presenterReadyPromise=new Promise(t=>{this.onPresenterReady=t}),this.isPresenterReady=!1}invalidateProxy(){this.invalidateFn&&this.invalidateFn()}async connectedCallback(){this._webSkelProps&&(this.props=this._webSkelProps.proxy),this.resources=await d.instance.ResourceManager.loadComponent(e),m(this.resources.html).forEach(i=>{i=i.slice(2),this.variables[i]=""}),this.templateArray=w(this.resources.html);let s=this,n=null;for(const i of s.attributes)s.variables[i.nodeName]=E(i.nodeValue),i.name==="data-presenter"&&(n=i.nodeValue);if(n){const i=async r=>{const l=h=>{s.innerHTML=`Error rendering component: ${s.componentName}
: `+h+h.stack.split(`
`)[1],console.error(h),d.instance.hideLoading()},u=async()=>{try{await s.webSkelPresenter.beforeRender();for(let h in s.variables)typeof s.webSkelPresenter[h]<"u"&&(s.variables[h]=s.webSkelPresenter[h]);s.refresh(),await s.webSkelPresenter.afterRender?.()}catch(h){l(h)}};if(d.instance.showLoading(),r)try{await r()}catch(h){return l(h)}await u(),d.instance.hideLoading()},a=new Proxy(i,{apply:async function(r,l,u){return s.isPresenterReady||await s.presenterReadyPromise,Reflect.apply(r,l,u)}});s.invalidateFn=a,s.webSkelPresenter=d.instance.ResourceManager.initialisePresenter(n,s,a,this.props)}else s.refresh()}async disconnectedCallback(){this._webSkelProps?.revoke(),this.webSkelPresenter&&this.webSkelPresenter.afterUnload&&await this.webSkelPresenter.afterUnload(),this.resources&&this.resources.css&&await d.instance.ResourceManager.unloadStyleSheets(this.componentName)}refresh(){let t="";for(let s of this.templateArray)s.startsWith("$$")?t+=this.variables[s.slice(2)]:t+=s;this.innerHTML=t}})}}return d});
